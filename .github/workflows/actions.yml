name: ModelOps (Model, Build, Deploy)

on:
  # push:
  workflow_dispatch:

permissions:
  packages: write

jobs:
  model:
    runs-on: ubuntu-latest
    steps:

      - name: checkout repo content
        uses: actions/checkout@v3 # checkout the repository content to github runner

      - name: setup python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13.0' # install the python version needed
          cache: 'pip'
          
      - name: install python packages
        run: pip install -r requirements.txt
          
      - name: scrape hikr data 
        working-directory: ./spider
        run: scrapy crawl gpx -s CLOSESPIDER_PAGECOUNT=50 -o file.jl

      - name: upload data to mongodb
        working-directory: spider/downloads
        run: python ./mongo_import.py -c tracks -i ../file.jl -u "${{secrets.MONGODB_URI}}"

      - name: build model
        working-directory: model
        run: python ./model.py -u "${{secrets.MONGODB_URI}}"

      - name: upload model
        working-directory: model
        run: python ./save.py -c "${{secrets.AZURE_STORAGE_CONNECTION_STRING}}"
        
  build:
    runs-on: ubuntu-latest
    needs: model  
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      
      - name: Log in to GitHub container registry
        uses: docker/login-action@v1.10.0
        with:
            registry: ghcr.io
            username: ${{ github.actor }}
            password: ${{ github.token }}
      
      - name: Lowercase the repo name and username
        run: echo "REPO=${GITHUB_REPOSITORY,,}" >>${GITHUB_ENV}
      
      - name: Build and push container image to registry
        uses: docker/build-push-action@v2
        with:
            push: true
            tags: ghcr.io/${{ env.REPO }}:${{ github.sha }}
            file: ./Dockerfile

  deploy:
      runs-on: ubuntu-latest
      needs: build
          
      steps:
      - name: Lowercase the repo name and username
        run: echo "REPO=${GITHUB_REPOSITORY,,}" >>${GITHUB_ENV}
          
      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v2
        with:
              app-name: ${{ env.AZURE_WEBAPP_NAME }}
              publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
              images: 'ghcr.io/${{ env.REPO }}:${{ github.sha }}'
          
    
